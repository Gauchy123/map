<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Map — Morocco Unified</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    #topbar {
      position: absolute; left: 12px; top: 12px; z-index: 5;
      background: rgba(255,255,255,0.95); padding: 8px; border-radius:6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15); display:flex; gap:8px; align-items:center;
    }
    #map { height:100%; width:100%; }
    #search { width:320px; padding:7px 10px; border:1px solid #ddd; border-radius:4px; }
    #info { position:absolute; left:12px; bottom:12px; z-index:5; background:rgba(255,255,255,0.95);
           padding:8px; border-radius:6px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); max-width:320px; }
    #info small{display:block;color:#666;margin-top:6px;}
  </style>
</head>
<body>
  <div id="topbar">
    <input id="search" placeholder="Search place in Morocco" />
    <button id="locBtn">My location</button>
    <button id="reloadBtn">Reload markers</button>
  </div>

  <div id="map"></div>

  <div id="info">
    <div id="msg">Click on the map to add a marker or search a place.</div>
    <small>Markers: sample (static) or loaded from your API.</small>
  </div>

  <script>
    // === SETTINGS ===
    const MARKERS_API_URL = "https://yourdomain.com/api/markers"; // <-- change or leave
    const USE_DYNAMIC_MARKERS = false; // set to true to fetch from your API

    const STATIC_MARKERS = [
      { lat: 33.573110, lng: -7.589843, title: "Casablanca" },
      { lat: 34.020882, lng: -6.841650, title: "Rabat" },
      { lat: 35.759465, lng: -5.833954, title: "Tangier" }
    ];

    const UNIFIED_MOROCCO_STYLE = [
      {"featureType":"administrative.country","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},
      {"featureType":"administrative.province","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},
      {"featureType":"administrative.land_parcel","stylers":[{"visibility":"off"}]}
    ];

    let map, marker, markersArray = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 31.5, lng: -7.99 },
        zoom: 6,
        styles: UNIFIED_MOROCCO_STYLE,
        gestureHandling: 'greedy'
      });

      map.addListener('click', (e) => placeMarker(e.latLng));

      // Places Autocomplete (restricted to Morocco)
      const input = document.getElementById('search');
      const autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: ['ma'] } });
      autocomplete.bindTo('bounds', map);
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) { alert('Place has no geometry'); return; }
        if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
        else map.setCenter(place.geometry.location);
        map.setZoom(14);
        placeMarker(place.geometry.location, place.name || place.formatted_address);
      });

      document.getElementById('locBtn').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
            const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            map.setCenter(p); map.setZoom(13); placeMarker(p, "You");
          }, () => alert('Could not get location (permission denied).'));
        } else alert('Geolocation not supported by this browser.');
      });

      document.getElementById('reloadBtn').addEventListener('click', loadMarkers);

      loadMarkers();
    }

    function clearMarkers() {
      markersArray.forEach(m => m.setMap(null));
      markersArray = [];
    }

    function placeMarker(latLng, title = '') {
      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({
        position: latLng,
        map,
        draggable: true,
        title: title || 'Marker'
      });
      google.maps.event.addListener(marker, 'dragend', () => {
        const p = marker.getPosition();
        document.getElementById('msg').innerText = `Marker moved: ${p.lat().toFixed(6)}, ${p.lng().toFixed(6)}`;
      });
      document.getElementById('msg').innerText = `Marker: ${typeof latLng.lat === 'function' ? latLng.lat().toFixed(6) : latLng.lat}, ${typeof latLng.lng === 'function' ? latLng.lng().toFixed(6) : latLng.lng}`;
    }

    function addMapMarker(obj) {
      const m = new google.maps.Marker({
        position: { lat: Number(obj.lat), lng: Number(obj.lng) },
        map,
        title: obj.title || '',
        icon: obj.iconUrl || null
      });
      const inf = new google.maps.InfoWindow({ content: `<strong>${obj.title || ''}</strong>` });
      m.addListener('click', () => inf.open(map, m));
      markersArray.push(m);
    }

    async function loadMarkers() {
      clearMarkers();
      document.getElementById('msg').innerText = 'Loading markers...';
      if (USE_DYNAMIC_MARKERS && MARKERS_API_URL) {
        try {
          const res = await fetch(MARKERS_API_URL);
          if (!res.ok) throw new Error('Network response not ok');
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('API must return JSON array');
          data.forEach(d => addMapMarker(d));
          document.getElementById('msg').innerText = `Loaded ${data.length} markers from API`;
          if (data.length) {
            const first = data[0];
            map.setCenter({ lat: Number(first.lat), lng: Number(first.lng) });
            map.setZoom(10);
          }
        } catch (err) {
          document.getElementById('msg').innerText = 'Failed to load markers from API — falling back to static';
          STATIC_MARKERS.forEach(s => addMapMarker(s));
        }
      } else {
        STATIC_MARKERS.forEach(s => addMapMarker(s));
        document.getElementById('msg').innerText = `Loaded ${STATIC_MARKERS.length} static markers`;
      }
    }
  </script>

  <!-- REPLACE YOUR_API_KEY_HERE with the new key (after rotation & restriction to https://gauchy123.github.io/*) -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwdJK-nccPr5xDAbIY4Fi0J0EZBK4Ulmk&libraries=places&region=MA&callback=initMap"></script>
</body>
</html>
